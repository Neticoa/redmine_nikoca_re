<% content_for :header_tags do %>
  <%= stylesheet_link_tag "index.css", :plugin => "redmine_nikoca_re" %>
<% end %>

<div class="contextual">
    <%= link_to_if_authorized(l(:label_conditions_new), 
                                {:action => 'new', :project_id => @project}, 
                                :class => 'icon icon-add') %>
</div>

<h2>ニコニコカレンダー</h2>
<div class="backnumber">
  <% if @backnumber == nil %>
    <%= link_to('<< 古いカレンダーへ', project_niko_faces_backnumber_path(@project, 1)) %>
  <% elsif @backnumber == 0 %>
    <%= link_to('<< 古いカレンダーへ', project_niko_faces_backnumber_path(@project, 1)) %>
  <% else%>
    <%= link_to('<< 古いカレンダーへ', project_niko_faces_backnumber_path(@project, @backnumber + 1)) %>
    <%= link_to('新しいカレンダーへ >>', project_niko_faces_backnumber_path(@project, @backnumber - 1)) %>
  <% end %>
</div>
<table class="username">
  <thead>
    <tr>
      <th>ユーザ名</th>
    </tr>
  </thead>
  <tbody>
    <% @users.each do |user| %>
      <tr class="<%= cycle('odd', 'even') %>">
        <td class="yyy"><%= link_to_user(user) %></td>
      </tr>
    <% end %>
</table>

<table class="calender">
  <thead>
    <tr>
      <% first_day = true %>
      <% @days.each do |date| %>
        <% if date.day == 1 %>
          <% date_s = date.month.to_s + "/" + date.day.to_s %>
          <% first_day = false %>
        <% elsif first_day %>
          <% date_s = date.month.to_s + "/" + date.day.to_s %>
          <% first_day = false %>
        <%else%>
          <% date_s = date.day.to_s %>
        <% end %>

        <% if date.wday == 0  %>
          <th class="sunday"><%= date_s %></th>
        <% elsif date.wday == 6 %>
          <th class="saturday"><%= date_s %></th>
        <% else %>
          <th><%= date_s %></th>
        <% end %>
      <% end %>
    </tr>
  </thead>

  <tbody>
    <% @users.each do |user| %>
      <tr class="<%= cycle('odd', 'even') %>">
      <% @days.each do |date| %>
        <% face = @niko_faces[user.name][date.day] %>
        <td>
        <% if face != nil %>
          <% face_icon = {1 => 'good.png', 2 => 'normal.png', 3 => 'bad.png'} %>
          <% feeling_label = {1 => :good, 2 => :normal, 3 => :bad} %>
          <% feeling = face.feeling %>
          <span><%= link_to(image_tag(face_icon[feeling], :plugin => 'redmine_nikoca_re', :width => "32", :height => "32", 
                            :alt => l(feeling_label[feeling])),project_niko_face_path(@project, face.id)) %></span>
          <div class="arrow_box">
            <%= (face.comment != '') ? face.comment : '(未投稿)' %>
            <% if !face.responses.empty?%>
              <br />
              <span class="responseinfo">
                <%= "コメント: #{face.responses.size}件" %>
              </span>
            <%end%>
          </div>
        <% end %>
        </td>
      <% end %>
      </tr>
    <% end %>
  </tbody>
</table>


